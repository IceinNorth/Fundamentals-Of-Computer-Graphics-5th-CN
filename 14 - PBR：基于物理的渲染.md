虽然所有的渲染在某种程度上都是“基于物理的”，但“基于物理的”一词意味着，在实践中，我们将严格遵循物理模型，而不是“现象学的”（经验之谈）。
“现象学的”（经验之谈），是一种启发式地捕捉主观感知特征的方法，比如在“正确”的地方放高光的经验公式。

本章涵盖了基于物理的高级渲染，定义了专用于本章的单位和术语，并提供了一种蛮力求解“路径跟踪”的算法，可以非常缓慢地生成非常精确的图像。
我们没有深入研究许多渲染算法的细节，但几乎所有这些算法都可以被视为对蛮力算法的改进。

注意，效率的提高是我们在电影和游戏中拥有逼真图像的原因，这是不容小觑的。我们不涉及这些细节，想看的话找Pfarr等人的PBRT书籍和代码库。
## 14.1 光子
在本章中，我们用大量光子集合的形式来描述辐射度量。请注意，在图形学中，“光子”并不一定准确地和它在物理学中表现得一样，许多物理学家在阅读图形学人员写的关于“光子追踪”之类的讨论时感到困惑。
对我们来说，光子通常只是一个携带能量得包裹，它的行为方式服从几何光学(光沿直线传播，但不具有波动特性)。

更准确地说，对我们而言，光子是一束光，它有位置、传播方向和波长λ。
奇怪的是，波长的国际单位制单位是纳米(nm)。这主要是由于历史原因，1 nm = 10−9 m。有时使用另一个单位埃，一纳米等于十埃。
光子还有一项属性——速度c只取决于它所经过介质的折射率n。有时频率f = c/λ也用于光。f很方便，与λ和c不同，当光子折射到具有新折射率n的介质中时，f不会改变。
另一个不变的度量是光子携带的能量q，由下式给出：
$$q=hf=\frac{hc}{\lambda}$$
其中h是普朗克常数。虽然这些量可以在任何单位制中测量，但我们将尽可能使用国际单位制。
## 14.2 光滑金属
对于光滑的金属，光要么像4.5.4节中描述的那样反射，要么被折射到表面，然后迅速吸收(薄涂层金属得表现有时和玻璃相近，你可以看到光一路穿过，金属实际上不是不透明的)。
反射光的量由菲涅耳方程决定。方程很简单，但很麻烦。此外，它们的值随光的偏振而变化，这是图形学中通常忽略的一个特性。菲涅耳方程的主要视觉效果是反射率随着入射角的增加而增加，特别是在接近掠角的地方，它达到100%。

几乎所有的图形程序都使用由Schlick(1994)开发的菲涅耳方程作为简单近似。
对于金属，我们通常指定正入射时的反射率R0(λ)。反射率应根据菲涅耳方程而变化，Schlick(1994)给出了一个很好的近似。
$$R(\theta,\lambda)=R_0(\lambda)+(1-R_0(\lambda))(1-\cos{\theta})^5$$
式中θ为光传播方向与表面法线之间的夹角。
这里，这个近似值允许我们通过数据或肉眼来设置金属的法向反射率。
## 14.3 光滑电介质（绝缘体）
电介质是一种能折射光线的材料。有一种很好的启发式的记忆方法——如果材料不是金属，那它就是电介质。
因此，皮肤、牛奶、头发、布料和几乎所有日常材料都是电介质，尽管它们往往是不透明的，因为它们是不同折射率和吸光杂质的混合物。但是光滑均匀的电介质（匀质）是透明的，例如玻璃、水和眼睛里的晶状体。

对于光滑的电介质，只有三个重要的性质:
1. 在每个入射角和波长反射多少光。
2. 当光以给定的距离和波长穿过材料时，有多少部分被吸收。
3. 反射光和折射光的方向是什么?

> 反射：Reflection
> 折射：Refraction
### 14.3.1 电介质的反射率
光的弯曲方式以及反射/透射的比例取决于材料的折射率n(λ)。
对于电介质，其反射性能也可以用Schlick方程来描述。然而，当其中一种材料是空气时，我们可以用n(λ)表示R0(λ)
$$R_o(\lambda)=\Big(  \frac{n(\lambda)-1}{n(\lambda)+1} \Big)^2$$
在方程两边的折射率不为1.0的情况下(如空气或真空)，则适用此公式：
$$R_o(\lambda)=\Big(  \frac{n_t(\lambda)-n_i(\lambda)}{n_t(\lambda)+n_i(\lambda)} \Big)^2$$
通常，n不随波长变化，但对于需要表现色散的程序(不同波长相互分散，得到彩虹)，n是可以变化的。
通常有用的折射率包括水(n = 1.33)，玻璃(n = 1.4至n = 1.7)和钻石(n = 2.4)。

透射的光量就是没有被反射的光量(能量守恒)。所以我们不需要显式地计算传递分数的公式。
### 14.3.2 反射与 Beer 法则
电介质也会过滤和折射光，有些玻璃滤除的红光和蓝光比绿光多，所以玻璃呈现出绿色色调。
当光线从折射率为n的介质传播到折射率为nt的介质时（$n_t\gt n$），如下图所示
![](pic/Pasted%20image%2020240326171042.png)
斯涅尔定律告诉我们：
$$n\sin{\theta}=n_t\sin{\phi}$$
计算两个向量之间正弦通常不像计算余弦那么方便，余弦是单位向量的简单点积。
使用三角恒等式sin + cos = 1。我们可以推导余弦的分数关系：
$$\cos^2{\phi}=1- \frac{n^2(1-\cos^2{\theta})}{n_t^2}$$
为了将$sin\phi$和$cos\phi$转换为3D向量，我们可以在曲面法线和光线方向的平面上建立2D正交基。
![](pic/Pasted%20image%2020240326173102.png)
n和b形成了折射平面的一个正交基。通过定义，我们可以用这个基来描述变换后的光线的方向：
$$t=\sin{\phi}\,b-\cos{\phi}\,n$$
因为我们可以用相同的基来描述d，并且d是已知的，我们可以解出b（直接用n和d解出b，而不使用叉乘的技术）：
![](pic/Pasted%20image%2020240326173259.png)
接下来直接解出t（只用b和n）：
![](pic/Pasted%20image%2020240326173443.png)
注意，不管n和nt哪个更大，这个方程都成立。一个直接的问题是，“如果平方根下的数字是负的，你应该怎么做?”
在这种情况下，没有折射光线，所有的能量都被反射了。这就是所谓的全内反射，它是玻璃物体丰富外观的主要原因。

对于均匀的杂质，例如有色玻璃，根据比尔定律，携带光线的强度会衰减。
当射线穿过介质时，它的强度损失按$dI=-CI\,dx$计算，其中x是距离。因此，$dI / dx=-CI$。我们可以解这个方程得到指数$I=k\cdot \exp{-Cx}$衰减程度用RGB衰减常数a来描述，它是经过单位距离后的衰减量。
引入边界条件，我们知道$I(0)=I_0\space and \space I(1)=aI(0)$。因此，最终公式：
$$I(s)=I_0\,e^{\ln{(a)}s}$$
式中I(s)为光束在距离界面s处的强度。我们也可以把它写成：
$$I(s)=I_0\,a^s$$
Beer定律的影响可以在图14.3中看到，玻璃呈现出绿色。
![](pic/Pasted%20image%2020240326173557.png)
这种效应也适用于透射光。请注意，光被反复反射和折射。通常，只有一个或两个反射图像是容易看到的。
![](pic/Pasted%20image%2020240326193842.png)
## 14.4 拥有次表面散射的电介质
只需使用光滑的电介质，我们就可以渲染一系列令人惊讶的材料。许多看起来无光泽和不透明的表面可以模拟为多个电介质。
考虑一个完美的冰块。它看起来像一块玻璃，只是其折射时扭曲光线的程度较小（冰的折射率比玻璃低）。现在在冰块内部放置许多小球形气穴，随着添加更多气泡，冰块将变得越来越不透明。

散射也许是我们所观察到的不透明现象的重要原因。 
使冰块看起来不透明的另一种方法是使表面变得粗糙。这可以在模型上通过细分表面然后对每个三角形顶点的位置进行小的扰动来完成。它的效果很像磨砂玻璃（本质上是那种粗糙的表面），扰动越粗糙，就会出现不透明度。

通过插入具有颜色的粒子可以实现进一步的复杂性，从而激活比尔定律。这是一个相当简单的模拟涂料的极其精确的方法。

我们能找到一大批材料，这些材料的复杂度可以通过显式建模它的微观结构来模拟。例如，人类皮肤可以建模为粗糙的表面和折射率略有不同的颜料颗粒层和血液（都遵守比尔定律）
## 14.5 暴力求解的光子追踪器
假设我们将场景建模为具有微观结构的电介质，然后用一盏灯照亮物体。我们怎样才能最简单地渲染它并生成图像呢？
在本节中，我们讨论如何蛮力模拟光子，然后如何从传感器反向发送伴随(向后)光子。这实际上可以产生一些最好的图形，用很少的代码，但会非常慢。
### 14.5.1 传感器
为了生成图像，我们必须对图像捕获设备有一些概念。
一个简单的组成是：一个简单的传感器阵列(像CCD)和一个有一个小孔的盒子，就像一个针孔相机。阵列中的每个传感器本质上都充当光子计数器(某些波长比其他波长引起更多的响应)。
在用光子轰击它之后，传感器阵列将具有可以作为图像写出来的值。接收到少量光子的传感器将被写入黑色，而接收到大量光子的传感器将被写入白色，在两者之间有不同的灰度。

为了生成彩色图像，我们可以在传感器前以某种模式放置红、绿、蓝滤光片。
最简单的滤波器是带通滤波器：
1. [400,500 nm]蓝色
2. 绿色[500,600 nm]
3. [600,700 nm]红色

如果将所有的传感器初始化为零，那么全响应意味着当光子击中传感器时增加传感器中值的大小。
### 14.5.2 光子追踪器
为了跟踪光子，在光源上随机选择一个点，随机选择一个方向和400到700 nm之间的随机波长(其他波长不会影响传感器阵列，因此不需要计算)。
当它碰到一个表面时，计算它的反射率并决定是反射还是折射。这个决定是通过计算波长和入射角的Schlick方程近似得出的，我们称它为R，现在生成一个均匀随机数ξ∈[0,1]。
![](pic/Pasted%20image%2020240326202258.png)
如果表面是金属的，那么光子在折射的情况下被吸收，我们在光源处生成一个新的光子。

如果光子进入电介质，而比尔定律系数不是1(意味着它像绿色玻璃一样吸收光)，那么光子可能被吸收(从而死亡)。我们使用与决定反射和折射相同的基本技术来决定：
![](pic/Pasted%20image%2020240326202503.png)
> 比尔定律的系数是a：$I(s)=I_0\,a^s$
### 14.5.3 运动和散焦模糊
上面的针孔相机将产生非常清晰的图像，就像一个真正的针孔相机。但这需要长时间的曝光，因为很少有光子能够幸运地在被吸收之前穿过针孔。

我们可以解决这个问题，在相机上增加一个镜头——把针孔变大，把镜头放在针孔里。我们可以模拟一套真正的复合玻璃透镜，或者我们可以插入一个理想的薄透镜。

我们可以把最简单的玻璃透镜建模成两个球体的重叠部分(“双凸球面透镜”)。
这有不错的成像特性(虽然不如大多数真实相机中的复合镜头好)，并且很容易做光线求交的代码。

薄透镜是一种理想的透镜，它是无限薄的(光线跟踪程序中的圆盘也是如此)，只指定半径(透镜的物理尺寸)和焦距f。薄透镜可以通过确定以下三个属性来实现:
1. 离开三维点p到达透镜中心的光线不会弯曲(我们称这条线从该点穿过p的中心线)。
2. 所有离开点p到达透镜的线都会在透镜之后汇聚在中心线上的点q。
3. 点p沿透镜光轴的距离a和点q沿透镜光轴的距离b，符合薄透镜规律：$1 / a+1 / b=1 / f$

通过“沿着光轴”，我们减少了沿着垂直于透镜的轴的距离(所以“沿着光线瞄准”)。请注意，使用真实或理想的镜头会自动产生真实照片中出现的那种模糊，通常称为散焦模糊或景深。为了解释运动模糊，移动的物体在照片中被模糊，或者移动的相机模糊了不以与相机相同速度移动的物体(例如，从火车上拍摄的照片，火车内部很清晰，风景很模糊)。如果我们支持以下两个功能，这个效果就会自动出现:
1. 光子是在相机记录(或相机快门打开)的时间间隔内以随机时间从光发射出来的。•
2. 光线追踪器具有将物体移动到光线交叉点的概念，代码将时间作为参数。
### 14.5.4 反转时间
## 14.6 辐射度量学
## 14.7 散射的辐射度量
## 14.8 传递方程
## 14.9 实际中的材质
## 14.10 蒙特卡洛光线追踪