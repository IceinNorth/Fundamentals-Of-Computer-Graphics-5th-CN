正如第19章所讨论的，人类的视觉系统适应了广泛的观看条件。在正常观看下，我们可以分辨出大约4到5个log单位的照明范围，也就是说，我们可以看到细节的最亮和最暗区域之间的亮度比可能高达100000：1。
通过适应过程，我们可以适应更大范围的光照。我们称与人类视觉系统的能力相匹配的图像为**高动态范围**图像。

视觉模拟通常会产生具有高动态范围的图像。图像捕捉技术的最新发展允许多次曝光对齐并重新组合成单个高动态范围图像。多重曝光技术也可用于视频。
此外，我们希望未来的硬件能够直接拍摄高动态范围的场景。一般来说，我们可以将每个像素视为浮点数的三元组。

随着创建高动态范围图像变得越来越容易，显示此类数据的需求正在迅速增加。不幸的是，大多数当前的显示设备，监视器和打印机，只能显示大约2个log单位（两个数量级）的动态范围。我们认为这种设备具有低动态范围。
目前存在的大多数图像都是用“byte-per-pixel-per-color”通道表示的，该通道与当前的显示设备相匹配，而不是与它们所代表的场景相匹配。
![](pic/Pasted%20image%2020240423192801.png)
通常，低动态范围的图像不能在不丢失信息的情况下表现场景。
一个常见的例子是一个室内房间，通过窗户可以看到一个室外区域。人类很容易就能看到室内和室外的细节。
传统的照片通常不能捕捉到这些全方位的信息——摄影师必须选择是室内还是室外的部分被适当曝光（见图20.1）。这些可以通过使用高动态范围成像和使用本章描述的技术来避免（见图20.2）。
![](pic/Pasted%20image%2020240423193352.png)
有两种策略可用于显示高动态范围图像。首先，我们可以开发可以直接适应高动态范围的显示设备。其次，我们可以准备高动态范围图像，以便在低动态范围显示设备上显示。这是目前比较常见的方法，也是本章的主题。
虽然我们预见高动态范围显示设备将在（不久的）将来得到广泛应用，但压缩图像动态范围的需求可能会减少，但不会消失。特别是，像这本书这样的印刷媒体，就其本质而言，是低动态范围的。
![](pic/Pasted%20image%2020240423193831.png)
**为了在低动态范围显示设备上显示而压缩图像值范围称为==色调映射==（Tonemapping）或==色调再现==（Tone Reproduction）**。
一个简单的压缩函数是将图像归一化（图20.3(左)）。这构成了线性缩放，只有当图像的动态范围仅略高于显示设备的动态范围时，线性缩放才足够。
对于具有较高动态范围的图像，较小的强度差异将被量化为相同的显示值，从而丢失可见细节。在图20.3(中)中，所有大于用户指定最大值的像素值都被设置为该最大值（即这些值被钳制）。这使得归一化较少依赖于噪声异常值，但这里我们在图像的明亮区域丢失了信息。
为了进行比较，图20.3(右)是一个色调映射版本，图中显示了暗区和亮区的细节。

一般来说，线性缩放不适合色调重构。
**色调重构的关键问题是在压缩图像的同时保留图像的一个或多个属性**。不同的色调重构算法关注不同的属性，如对比度、可见细节、亮度或外观。

理想情况下，在低动态范围显示设备上显示色调映射图像将在观察者眼中产生与原始场景相同的视觉反应。考虑到显示设备的限制，这是不可能实现的，我们可以尽可能地接近这个目标。
![](pic/Pasted%20image%2020240423194346.png)
作为一个例子，我们创建了如图20.4所示的高动态范围图像。然后将该图像进行色调映射并显示在显示设备上。然后将显示设备本身放置在场景中（图20.5）。在理想的情况下，显示的图像应当与环境融为一体。根据色调重构算法的质量以及所描绘场景的性质，这一目标也许更容易/困难实现。
![](pic/Pasted%20image%2020240423194403.png)
## 20.1 分类
虽然可以根据它们旨在保留的属性或开发的任务对色调重构算法进行分类，但我们根据它们的一般技术对算法进行分类。这将使我们能够展示大量不同算法之间的差异和相似之处，因此，希望对色调重构任务选择合适的算法给出有意义的指导。

我们遵循的主要分类方案基于从各个学科获得的见解。特别地，一些算法是基于人类视觉感知的知识。
人类的视觉系统利用视网膜上的感光器来探测光线。光被转换成电信号，在视网膜中部分处理，然后传输到大脑。除了视网膜上最初的几层细胞外，从检测到的光中产生的信号是通过脉冲序列传输的。承载的信息量就是这些电脉冲发生的频率。

人类视觉系统所能探测到的光的范围远远大于人类大脑用来传递信息的频率范围（？？？）。因此，人类视觉系统毫不费力地解决了色调重构问题——大范围的亮度被转换成小范围的脉冲序列频率。因此，模拟人类视觉系统是一种有价值的色调重构方法。

第二类算法以物理学为基础。光在被光感受器吸收之前与表面和体积相互作用。在计算机图形学中，光相互作用通常由渲染方程来建模。对于纯粹漫反射表面，该方程可以简化为入射到表面上的光（照度）与该表面的反射光能力（反射率）之间的乘积。

由于反射率是表面的被动属性，因此对于漫反射表面，根据定义，反射率是低动态范围的——通常在0.005和1之间。
一个表面的反射率不能大于1，否则它反射的光会比入射到表面的光多。另一方面，照度可以是任意大的值，并且只受光源的强度和接近程度的限制。

因此，图像的动态范围主要由照度决定。因此，对于漫射场景，一种可行的色调重构方法是将反射率与照度分离，压缩照度分量，然后重新组合图像。

然而，假设场景中的所有表面都是漫射的通常是不正确的。许多高动态范围图像描绘高光和直接可见的光源。镜面反射的亮度几乎和它反射的光源一样高。

目前使用的各种色调重构算法将图像分成**高动态范围基础层**和**低动态范围细节层**。如果所描绘的场景完全是漫射的，这些层将表示**照度**（光源）和**反射率**（被照射物体）。
对于包含直接可见光源或镜面高光的场景，划分为基础层和细节层仍然允许设计有效的色调重构算法，尽管单独的层没有直接的意义。
## 20.2 动态范围
传统图像以每像素一个字节的方式存储红、绿、蓝三色成分。这种编码所提供的动态范围取决于最小和最大可表示值之间的比率，以及连续值之间的步长。因此，对于低动态范围的图像，每个颜色通道只有256个不同的值。

高动态范围图像编码可能的值则是一个明显更大的集合。最大值要大得多，且连续值之间的步长也要小得多。因此，高动态范围图像的文件大小通常也更大，例如OpenEXR文件。

限制文件大小的另一种方法是对高动态数据应用色调重构算法。然后可以将结果编码为JPEG格式。此外，输入图像可以由色调映射的图像按像素划分。然后可以对这种划分的结果进行次采样，并将其作为少量数据存储在相同的JPEG图像的头部（Header）中。这种子带（Sub-Band）编码图像的文件大小与传统JPEG编码图像的顺序相同。显示程序可以直接显示JPEG图像，也可以通过将色调映射的图像与存储在头部（Header）中的数据相乘来重建高动态范围图像。

一般来说，**最小步长**和**最小可表示值与最大可表示值之比**的组合决定了图像编码方案提供的动态范围。对于计算机生成的图像，在写入文件或显示在屏幕上之前，图像通常被存储为浮点值的三元组，尽管可能有更有效的编码方案。
由于大多数显示设备仍然配备8位D/A转换器，我们可以认为色调重构是浮点数到字节的映射，这样结果就可以在低动态范围显示设备上显示。

单个图像的动态范围通常较小，由场景中发现的最小和最大亮度决定。因此，测量图像的动态范围的简单方法可以计算图像的最大和最小像素值之间的比率。对异常值的敏感性可以通过忽略一小部分最暗和最亮的像素来降低。

或者，相同的比率可以表示为对数域中的差。这一措施对异常值不太敏感。注意，在这种情况下，夜景的动态范围并不比白天场景小。虽然夜景中的所有值都较小，但最大值和最小值之间的比例并非如此。

然而，记录设备或渲染算法可能会引入噪声，从而降低有用的动态范围。因此，测量图像的动态范围应考虑噪声。
更好的动态范围测量方法是信号处理中使用的以分贝表示的信噪比。
## 20.3 色彩
色调重构算法通常压缩亮度值，而不是直接在彩色图像的红、绿、蓝分量上工作。在这些亮度值被压缩成显示值Ld(x, y)之后，可以通过保持颜色通道之间的比率与压缩前相同（使用s = 1）来重建彩色图像：
![](pic/Pasted%20image%2020240423203459.png)
结果经常出现过饱和，因为人类的色彩感知相对于整体亮度水平是非线性的。这意味着，如果我们在昏暗的环境中观看显示器上明亮的室外场景图像，我们的眼睛会适应昏暗的环境，而不是室外照明。通过保持色彩比例不变，我们便无需考虑这种影响。
![](pic/Pasted%20image%2020240423201713.png)
或者，可以选择小于1的饱和常数s。这样的单通道伽玛校正可以使结果去饱和到一个适当的水平。一个更全面的解决方案是将色彩外观建模领域的想法纳入色调重构算法。

最后，如果一个具有代表性颜色方案的示例图像已经可用，则可以将该颜色方案应用于新图像。图像之间的这种颜色映射可以用于细微的颜色校正，例如饱和度调整或用于更有创造性的颜色映射。
映射通过将源图像和目标图像转换为去相关的颜色空间来进行。在这样的色彩空间中，每个色彩通道中的像素值可以独立处理，而不会引入太多的伪影。

在去相关的色彩空间中，将颜色从一张图像映射到另一张图像是很简单的：分别计算源图像和目标图像中三个颜色通道的所有像素的平均值和标准差。然后，对目标图像进行平移和缩放，使目标图像在每个颜色通道中的均值和标准差与源图像相同。然后通过将去相关色彩空间转换为RGB并将负像素钳制为零来获得结果图像。
应用该算法后，图像的动态范围可能会发生变化。因此，建议将该算法应用于高动态范围图像，然后应用传统的色调重构算法。
## 20.4 图像形成
现在，我们假设图像是由于光被表面漫反射而形成的。我们将这一限制放宽到直接描绘光源和高光的场景。每个像素点的亮度Lv近似为以下乘积:
$$L_v(x,y)=r(x,y)\,E_v(x,y)$$
其中，r为表面反射率，Ev为照度。下标v表示我们使用的是光度加权量。或者，我们也可以把这个表达式写在对数域中：
![](pic/Pasted%20image%2020240423204900.png)
照相透明片通过改变材料的密度来记录图像。在传统摄影中，这种变化与亮度呈对数关系。因此，与摄影中的常见做法类似，我们将使用术语密度表示(D)来表示对数亮度。当在对数域中表示时，反射率和照度是相加的。这有助于分离这两个组件，尽管分离反射率或照度是一个受限的问题。在实践中，分离只能在一定程度上是可能的，并且取决于图像的组成。尽管如此，色调再现可以基于图像形成的这两个组成部分的分离。
## 20.5 基于频率算法
## 20.6 基于梯度算法
## 20.7 空间算法
## 20.8 除法（Division）
## 20.9 Sigmoids
## 20.10 其他方法
## 20.11 夜间色调映射