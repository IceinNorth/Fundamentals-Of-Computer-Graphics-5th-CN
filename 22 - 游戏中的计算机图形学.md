# 22 - 游戏中的计算机图形学
在计算机图形学的所有应用中，计算机和视频游戏可能最引人注目。为特定游戏选择的图像方法不仅会对游戏引擎代码产生深远影响，还会对美术资产创造产生影响，甚至有时还会对玩法或核心游戏机制产生影响。

尽管游戏图像依赖于前面所有章节的内容，但有两章是特别相关的。游戏需要高效地使用图形硬件，所以理解第**17章**的内容很重要。

在这一章中，将详细阐述游戏开发中与图像相关的具体考虑因素，从游戏运行的平台到游戏制作过程。
## 22.1 平台
在这里，我使用“平台”一词来指代硬件、操作系统和API（应用程序编程接口）的特定组合。游戏运行在各种各样的平台上，从用于基于浏览器的游戏的虚拟机到使用专用硬件和api的专用游戏机。

在过去，针对单一平台设计游戏是很常见的。游戏开发成本的增加使得这种情况变得罕见。如今，多平台游戏开发已成为常态。为了支持多个平台而增加的开发成本可能会增加两倍或三倍的用户基础。

有些平台的定义非常松散。例如，当面向Windows PC平台开发游戏时，开发者必须考虑各种可能的硬件配置。游戏甚至被期待在不存在的PC配置上运行。由于Windows平台定义的api抽象接口，使得这才成为可能。

开发人员解释图形性能差异的一种方法是根据系统功能调整图形质量。这可以确保在低配系统上的合理性能，同时在高性能系统上仍然获得有竞争力的视觉效果。
这种调整有时是通过分析系统性能自动完成的，但更多的时候，这种控制权留给了用户，他们可以最好地判断自己对质量和速度的个人偏好。
显示分辨率最容易调整，其次是抗锯齿质量。为视觉效果（如阴影和动态模糊）提供几个质量级别也是相当常见的，包括完全关闭效果的选项。

图像性能的差异可能非常大，以至于有些机器可能无法以可玩的帧速率运行游戏，即使是在最低质量设置下。因此，PC游戏开发者会针对每款游戏发布最低规格和推荐规格。

作为平台，游戏主机有着严格的定义。当开发一款游戏时，例如任天堂的Wii主机，开发者清楚地知道游戏将在什么硬件上运行。如果平台的硬件实现发生了变化（通常是为了降低制造成本），主机制造商必须确保新实现与前一个在表现上完全相同，包括时间和性能。
这并不是说主机开发者的任务很简单。控制台api往往不那么抽象，更接近底层硬件。这给主机开发带来了自己的困难。从某种意义上说，多平台开发（通常包括至少两个不同的主机平台，通常也包括Windows）是最难的，因为多平台游戏开发者既不能保证固定的平台，也不能获得单一高级API的便利。

基于浏览器的虚拟机（如Adobe Flash）是一类有趣的游戏平台。尽管这样的虚拟机运行在从个人电脑到移动电话的各种硬件上，但虚拟机提供的高度抽象得到了一个稳定和统一的开发平台。这些平台相对容易的开发和庞大的潜在用户群使它们对游戏开发者越来越有吸引力。然而，这些平台是由所支持硬件的最小公分母定义的，在任何给定平台上，虚拟机的性能都低于本机。基于这些原因，这类平台最适合图像要求不高的游戏。

平台的特点还在于其对开发的开放性，这是商业或法律上的区别，而不是技术上的区别。
例如，Windows是开放的，因为开发工具是广泛可用的，并且不存在控制Windows游戏市场准入的守门人。苹果的iPhone是一个更受限制的平台，因为所有应用程序都需要通过认证程序，某些类别的应用程序被完全禁止。主机是最受限制的游戏平台，在这里使用开发工具受到严格控制。
随着更开放的在线主机游戏市场的出现，这种情况有所改观。一个特别有趣的例子是微软的Xbox LIVE社区游戏服务，在那里开发工具是免费的，“把关”主要是通过同行评审来完成的。出于安全考虑，通过该服务分发的游戏必须使用微软提供的虚拟机平台。

游戏平台决定了游戏体验的许多元素。例如，PC玩家使用键盘和鼠标，而主机玩家使用专门的游戏控制器。
许多主机游戏支持同一主机上的多个玩家，要么共享一个屏幕，要么为每个玩家提供一个窗口。由于共用键盘和鼠标的困难，这种类型的游戏在PC上找不到。手持游戏系统将拥有与触屏手机不同的控制方案。

尽管游戏平台各不相同，但我们还是可以发现一些共同的趋势。大多数平台都有多个处理核心，分为通用(CPU)和图形专用(GPU)。
随着时间的推移，性能的提高主要是由于核心数量的增加；单核心表现的提升幅度不大。随着GPU的普及，GPU和CPU内核之间的界限越来越模糊。存储容量的增长速度往往慢于处理能力的增长速度，通信带宽（核心之间以及每个核心与存储之间）的增长速度更慢。
## 22.2 有限资源
游戏图像的主要挑战之一是需要管理多个有限资源池。每个平台对硬件资源（如处理时间、存储和内存带宽）都有自己的限制。
在更高一级，还需要管理开发资源；这是一个由程序员、美工和游戏设计师组成的固定规模团队，并在有限的时间内完成游戏。在决定采用哪种图形技术时，需要考虑到这一点（如何管理开发资源）。
### 22.2.1 处理时间
早期的游戏开发者只需要担心单个处理器的预算问题。当前的游戏平台包含多个CPU和GPU内核。这些处理器需要小心地同步，以避免死锁或过多的停机。

由于单个渲染命令所消耗的时间变化很大，因此图形处理器通过命令缓冲区与系统的其余部分解耦。这个缓冲区就像一个队列；命令存储在一端，GPU从另一端读取渲染命令。增加这个缓冲区的大小可以减少GPU饥饿的机会（不在工作的时间）。
游戏在将渲染命令发送给GPU之前缓冲整个帧的渲染命令是相当常见的；这保证了不会发生GPU饥饿。然而，这种方法需要为两个完整帧的命令保留足够的存储空间（GPU在一个上工作，而CPU在另一个上存储命令）。它还增加了用户输入和显示之间的延迟，这对于快节奏游戏来说可能是个问题。

处理预算是由帧速率决定的，帧速率是场景的新渲染刷新帧缓冲区的频率。在固定平台（如主机）上，用户体验到的帧率基本上与游戏开发者看到的帧率相同，因此可以施加相当严格的帧率限制。大多数游戏的目标帧率是每秒30帧；在响应延迟特别重要的游戏中，目标通常是每秒60帧。在高度可变的平台（如pc）上，帧率预算的定义更为宽松。

所需的帧速率为图形程序员提供了固定的每帧预算。在30 fps目标的情况下，CPU核心有33毫秒的时间来收集输入，处理游戏逻辑，执行任何物理模拟，遍历场景描述，并将渲染命令发送到图形硬件。同时，其他任务（如音频和网络处理）也必须按照它们自己的响应时间进行处理。当这种情况发生时，GPU通常执行在前一帧中提交的图形命令。

在大多数情况下，CPU内核是各向同性资源。所有内核都是相同的，并且它们中的任何一个都同样适合给定的工作负载（也有一些例外，例如索尼PLAYSTATION 3主机中使用的Cell处理器）。

相比之下，gpu包含了各种资源的混合，每个资源都专门用于特定的任务集。其中一些资源由固定功能硬件组成（用于三角形光栅化、alpha混合和纹理采样），还有一些是可编程核心。在较老的gpu上，可编程核进一步分化为顶点处理核和像素处理核；较新的GPU设计有统一的着色器内核，可以执行任何可编程的着色器类型。

这些异构资源是单独预算的。通常，在任何时候，只有一种资源类型将成为瓶颈，而其他资源类型将具有多余的容量。
一方面，这很好，因为这种容量可以在不降低性能的情况下提高视觉质量。
另一方面，它使提高性能变得更加困难，因为减少任何非瓶颈资源的使用都不会产生任何效果。即使减少瓶颈资源的使用也只能略微提高性能，这取决于“下一个瓶颈”的利用程度。
### 22.2.2 存储
与任何现代计算系统一样，游戏平台也拥有多阶段存储层次结构，更小、更快的内存类型位于顶部，更大、更慢的存储类型位于底部。这种安排是出于工程上的需要，尽管它确实使开发人员的生活变得复杂。大多数平台包括光盘存储，这是极其缓慢的，主要用于交付。在Windows等平台上，将所有数据从光盘移动到硬盘驱动器需要执行一次漫长的安装过程，这要快得多。光盘永远不会再使用(除非作为反盗版措施)。在主机平台上，这种情况不太常见，尽管有时会在保证硬盘驱动器存在的情况下发生，如索尼的PLAYSTATION 3主机。更常见的情况是，硬盘驱动器(如果存在的话)仅用作光盘的缓存。
### 22.2.3 开发资源
## 22.3 优化技术
## 22.4 游戏类型
## 22.5 游戏生产过程